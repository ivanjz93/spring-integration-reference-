# 3.1背景

Spring框架的关键主题之一是控制反转。从最广泛的意义上讲，这意味着框架代表在其上下文中管理的组件处理责任。这些组件本身被简化，因为它们免除了这些责任。例如，依赖注入减轻了查找或创建依赖关系的责任。同样，面向切面编程通过将业务组件模块化为可重用的切面来减轻通用交叉问题的业务组件。在每种情况下，最终结果都是一个更容易测试、理解、维护和扩展的系统。

此外，Spring框架和产品组合为构建企业级应用程序提供了全面的编程模型。开发人员从这个模型的一致性中受益匪浅，特别是它基于已经建立的最佳实践，如编程接口和有利于继承的组合。 Spring的简化抽象和强大的支持库提高了开发人员的生产力，同时提高了可测试性和可移植性。

Spring Integration由这些相同的目标和原则驱动。它将Spring编程模型扩展到消息传递领域，并以Spring现有的企业集成支持为基础，提供更高级别的抽象。它支持消息驱动的体系结构，在这种体系结构中，控制反转适用于运行时问题，比如何时执行某些业务逻辑以及应该发送响应的位置。它支持消息的路由和转换，以便在不影响可测试性的情况下集成不同的传输和不同的数据格式。换言之，消息传递和集成问题由框架处理，因此业务组件与基础架构进一步隔离，开发人员免除了复杂的集成责任。

作为Spring编程模型的扩展，Spring Integration提供了各种配置选项，包括注释、带有命名空间支持的XML、带有通用“bean”元素的XML、当然还有直接使用底层API。该API基于明确定义的策略接口和非侵入式委托适配器。 Spring Integration的设计灵感来自于Spring内部常见模式与Gregor Hohpe和Bobby Woolf（Addison Wesley，2004）在同名书中描述的著名的“企业集成模式“。已经阅读过这本书的开发人员应该立即对Spring Integration概念和术语感到熟悉。

# 3.2 目标和原则

Spring Integration被以下目标驱动：

* 为实现复杂的企业集成解决方案提供简单的模型；

* 在基于Spring的应用程序中使用异步、消息驱动的行为；

* 促进现有Spring用户直观、渐进的使用。

Spring Integration由以下原则指导：

* 组件应该松耦合以实现模块化和可测试性；
* 框架应该强化业务逻辑和集成逻辑之间的分离；
* 扩展点本质上应该是抽象的，但是应该在明确的边界内，以提高重用性和可移植性。

# 3.3 主要组件

从垂直角度看，分层架构有助于分离关注点，基于接口的层之间的契约促进了松耦合。基于Spring的应用程序通常是以这种方式设计的，而Spring框架和产品组合为遵循这种针对整个企业应用程序的最佳实践提供了坚实的基础。消息驱动的体系结构增加了一个水平的角度，但是这些相同的目标仍然是相关的。就像“分层架构”是一个非常通用和抽象的范例一样，消息传递系统通常遵循类似抽象的“管道和过滤器”模型。 “过滤器”表示能够产生和/或消费消息的任何组件，“管道”在过滤器之间传输消息，使得组件本身保持松散耦合。需要指出的是，这两个高层次的范式并不是相互排斥的。支持“管道”的底层消息传递基础结构仍应被封装在将合约定义为接口的层中。同样，“过滤器”本身通常会在逻辑上位于应用程序服务层之上的层中进行管理，并通过与Web层大致相同的方式与这些服务进行交互。

## 3.3.1 消息

在Spring Integration中，消息是一个通用的包装器，用于包装任何Java对象和处理该对象时框架使用的元数据。它由有效载荷和标题组成。有效载荷可以是任何类型的，并且头部保存通常需要的信息，诸如id，时间戳，相关性id和返回地址。头也用于传递连接传输的值。例如，当从接收到的文件创建消息时，文件名可以存储在头中以供下游组件访问。同样，如果消息的内容最终将由出站邮件适配器发送，则上游组件可以将各种属性（来自cc，主题等）配置为消息头的值。开发人员也可以在头文件中存储任意的键值对。

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/message.jpg)

## 3.3.2 消息通道

消息通道表示管道和过滤器体系结构的“管道”。生产者将消息发送到通道，消费者从通道接收消息。因此，消息通道将消息组件解耦，并为消息的拦截和监视提供便利点。

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/channel.jpg)

消息通道可以遵循点对点或发布/订阅语义。使用点对点通道，至多一个消费者可以接收发送到该通道的每个消息。另一方面，发布/订阅通道将尝试把每个消息广播给其所有订阅者。 Spring集成对两者都支持。

尽管“点对点”和“发布/订阅”定义了有多少消费者将最终接收每条消息的两个选项，但还有一个重要的考虑因素：通道是否应该缓冲消息？在Spring Integration中，可轮询的通道能够缓冲队列中的消息。缓冲的好处是可以限制入站消息，从而防止消费者过载。然而，顾名思义，这也增加了一些复杂性，因为如果配置了轮询器，消费者只能从这样的频道接收消息。另一方面，连接到可订阅频道的消费者仅是消息驱动的。 Spring集成中可用的各种通道实现将在第4.1.2节“消息通道实现”中详细讨论。

## 3.3.3 消息端点

Spring Integration的主要目标之一是通过控制反转来简化企业集成解决方案的开发。这意味着开发者不必直接实现消费者和生产者，而且甚至不必在消息通道上构建消息并调用发送或接收操作。相反，开发者应该能够使用基于普通对象的实现来关注特定的域模型。然后，通过提供声明性配置，可以将特定于域的代码“连接”到Spring Integration提供的消息传递基础结构。负责这些连接的组件是消息端点。这并不意味着必须直接连接现有的应用程序代码。任何现实世界的企业集成解决方案都需要一定量的代码来集中关注路由和转换等集成问题。重要的是要实现这种集成逻辑和业务逻辑之间的关注点分离。换句话说，就像Web应用程序的Model-View-Controller范例一样，目标应该是提供一个精简但专用的层，将入站请求转换为服务层调用，然后将服务层返回值转换为出站应答。下一节将提供处理这些职责的消息端点类型的概述，在下面的章节中，将看到Spring Integration的声明性配置选项如何提供一种非侵入性的方式来使用其中的每一个类型。

# 3.4 消息端点

消息端点表示“管道和过滤器”体系结构的“过滤器”。如上所述，端点的主要作用是将应用程序代码连接到消息传递框架，并以非侵入的方式执行此操作。换句话说，应用程序代码应该理解为不知道消息对象或消息通道。这与MVC范例中的Controller的角色类似。就像Controller处理HTTP请求一样，Message Endpoint也处理消息。正如控制器被映射到URL模式一样，消息端点被映射到消息通道。在这两种情况下，目标是相同的：从基础设施中隔离应用程序代码。这些概念和下面所有的模式在“企业集成模式”一书中有详细讨论。在这里，我们只提供Spring Integration支持的主要端点类型及其角色的高级描述。下面的章节将详细阐述并提供示例代码以及配置示例。

## 3.4.1 转换器

消息转换器负责转换消息的内容或结构并返回修改后的消息。最常见的转换器可能是将消息的有效载荷从一种格式转换为另一种格式（例如，从XML文档转换为java.lang.String）。同样，可以使用转换器来添加、删除或修改消息头的值。

## 3.4.2 过滤器

消息过滤器决定是否应将消息传递到输出通道。这只需要一个布尔测试方法，可以检查特定的有效载荷内容类型、属性值和相关的头是否存在等。如果消息被接受，它被发送到输出通道，但是如果不是，它将被丢弃（或者对于更严格的实现，可能抛出异常）。消息过滤器通常与“发布预订”通道一起使用，其中多个消费者可能会收到相同的消息，并使用过滤器来根据某些条件缩小要处理的消息集。

_注意不要将“管道和过滤器”架构模式中的“过滤器”的通用用法与这种特定的端点类型相混淆，该类型可以选择性地缩小两个通道之间的消息流。 “过滤器和管道”概念中的过滤器概念与Spring Integration的消息端点更匹配：任何组件可以连接到消息通道以发送和/或接收消息。_

## 3.4.3 路由器

消息路由器负责决定接下来应该接收消息的通道（如果有的话）。通常，该决定基于消息的内容和/或消息头中可用的元数据。消息路由器通常用作服务激活器或其他能够发送回复消息的端点上静态配置的输出通道的动态替代方案。同样，消息路由器为多个订阅者使用的反应消息过滤器提供了主动的替代方案。

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/router.jpg)

## 3.4.4 分离器

分离器是另一种类型的消息端点，其职责是接受来自其输入通道的消息，将该消息拆分成多个消息，然后将每个消息发送到其输出通道。这通常用于将“组合的”有效载荷对象分成包含被细分的有效载荷的一组消息。

## 3.4.5 聚合器

基本上是分离器的镜像，聚合器是一种消息端点，它接收多个消息并将它们组合成单个消息。实际上，聚合器通常是包含分离器的管道的下游消费者。从技术上讲，聚合器比分离器更复杂，因为它需要维护状态（要聚合的消息），决定何时可以使用完整的消息组，并在必要时超时。此外，如果超时，聚合器需要知道是发送部分结果还是丢弃到单独的通道。 Spring Integration提供了CorrelationStrategy、ReleaseStrategy和可配置的设置：超时，是否发送超时部分结果，以及丢弃通道。

## 3.4.6 服务激活器

服务激活器是将服务实例连接到消息传递系统的通用端点。必须配置输入消息通道，并且如果需要调用的服务方法能够返回值，则也可以提供输出消息通道。

_输出通道是可选的，因为每个消息也可以提供它自己的返回地址头。同样的规则适用于所有消费者端点。_

服务激活器调用某个服务对象上的操作来处理请求消息，提取请求消息的有效负载并在必要时进行转换（如果该方法不期望消息类型的参数）。每当服务对象的方法返回一个值时，如果需要（如果它不是消息），那么返回值同样会被转换为回复消息。该回复消息被发送到输出通道。如果没有配置输出通道，则回复将被发送到消息“返回地址”中指定的通道（如果可用）。

请求回复“服务激活器通过”端点连接目标对象的方法来输入和输出消息通道。

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/handler-endpoint.jpg)

_如上面的消息通道所述，通道可以是可以轮询的或可订阅的；在该图中，由“时钟”符号和实线箭头（轮询）以及虚线箭头（订阅）来描绘。_

## 3.4.7 通道适配器

通道适配器是将消息通道连接到某个其他系统或传输的端点。通道适配器可以是入站或出站的。通常情况下，通道适配器将在消息和从其他系统（文件，HTTP请求，JMS消息等）接收或发送的任何对象或资源之间进行一些映射。根据传输，通道适配器也可以填充或提取消息头的值。 Spring Integration提供了许多通道适配器，将在以后的章节中对它们进行描述。

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/source-endpoint.jpg)

_消息源可以是可轮询的（例如POP3）或消息驱动的（例如，IMAP空闲）；在这个图中，由“时钟”符号和实线箭头（轮询）和虚线箭头（消息驱动）来描绘。_

![](https://docs.spring.io/spring-integration/docs/5.0.0.RELEASE/reference/html/images/target-endpoint.jpg)

_如上面的消息通道所述，通道可以是可以轮询的或可订阅的；在该图中，由“时钟”符号和实线箭头（轮询）以及虚线箭头（订阅）来描绘。_  
































  




